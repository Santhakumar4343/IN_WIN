package com.os.inwin.serviceImpl;

import java.time.LocalDate;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import com.os.inwin.entity.Gold;
import com.os.inwin.goldapi.MetalPriceApiResponse;
import com.os.inwin.repository.GoldRepository;

@Service
public class GoldPriceService {
    @Autowired
    private RestTemplate restTemplate;

    @Autowired
    private GoldRepository goldRepository;

    private static final String BASE_URL = "https://api.metalpriceapi.com/v1";
    private static final String API_KEY = "d317d1fb8a5c931a60dad6efd5e6529a";

    public double getCurrentPriceAndUpdate() {
        String apiUrl = BASE_URL + "/latest?api_key=" + API_KEY;
        MetalPriceApiResponse response = restTemplate.getForObject(apiUrl, MetalPriceApiResponse.class);
        if (response != null && response.getData() != null && response.getData().getGold() != null) {
            double currentPrice = response.getData().getGold().getPrice();
            System.out.println(currentPrice);
            updateGoldPrices(currentPrice);
            return currentPrice;
        } else {
        	System.out.println("eles stament was called");
            return 0.0; 
        }
    }

    private void updateGoldPrices(double currentPrice) {
        Iterable<Gold> goldList = goldRepository.findAll();
        for (Gold gold : goldList) {
            gold.setCurrentPrice(currentPrice);
            gold.setLastUpdateDate(LocalDate.now());
            goldRepository.save(gold);
        }
    }
}
